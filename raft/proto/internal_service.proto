syntax = "proto3";
package raft.internal;

service RaftInternalService {
    rpc AppendEntries (AppendEntriesRequest) returns (AppendEntriesResponse);
    rpc RequestVote (RequestVoteRequest) returns (RequestVoteResponse);
    rpc InstallSnapshot(InstallSnapshotRequest) returns (InstallSnapshotResponse);
}

message AppendEntriesRequest {
    int32 term = 1;
    string leaderId = 2;
    int32 prev_log_index = 3;
    int32 prev_log_term = 4;
    repeated LogEntry entries = 5;
    int32 leader_commit = 6;
    string recipient_id = 7; // ID of the node receiving this request
}

message AppendEntriesResponse {
    int32 term = 1;
    bool success = 2;
}

message RequestVoteRequest {
    int32 term = 1;
    string candidate_id = 2;
    int32 last_log_index = 3;
    int32 last_log_term = 4;
}

message RequestVoteResponse {
    int32 term = 1;
    bool vote_granted = 2;
}

message LogEntry {
    int32 term = 1;
    int32 index = 2;
    oneof entry_type {
        ClientCommand client_command = 3;
        ConfigurationChange config_change = 4;
        NoOpEntry no_op = 5;
    }
}

enum NoOpEntry {
    UNKNOWN = 0;
    LEADER_HEARTBEAT = 1; // Confirms leadership (term change or periodic)
    FORCE_COMMIT = 2;     // Used to help commit previous logs
}

message ClientCommand {
    string key = 1;
    int32 value = 2; // TODO: Change to an enum for key and value
    CommandType command_type = 3;
}

enum CommandType {
    PUT = 0;
    DELETE = 1;
    GET = 2;
}

message InstallSnapshotRequest {
    int32 term = 1;
    string leader_id = 2;
    int32 last_included_index = 3;
    int32 last_included_term = 4;
    int64 offset = 5;                    
    bytes data = 6;
    bool done = 7;
}

message InstallSnapshotResponse {
    int32 term = 1;
    bool success = 2;
    int64 bytes_received = 3;
    string error_message = 4;
}

message ConfigurationChange {
    ClusterConfiguration new_configuration = 1;
    ClusterConfiguration old_configuration = 2;
}

message ClusterConfiguration {
    repeated NodeInfo nodes = 1;
    int64 configuration_index = 2;  // Log index where this config was committed
    string configuration_id = 3;   // Unique ID for this configuration
}

message NodeInfo {
    string node_id = 1;
    string internal_address = 2; 
    string client_address = 3; 
    NodeRole role = 4;
    NodeStatus status = 5;
}

enum NodeRole {
    VOTING_MEMBER = 0;
    NON_VOTING_MEMBER = 1;  
    LEARNER = 2;  
}

enum NodeStatus {
    ACTIVE = 0;
    JOINING = 1;  
    LEAVING = 2; 
    INACTIVE = 3;
    SYNCING = 4;
}